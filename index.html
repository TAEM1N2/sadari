<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‹ ë‚˜ê²Œ ì•„ì´ìŠ¤í¬ë¦¼ ì‚¬ê¸°</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2f6bff" />
<link rel="apple-touch-icon" href="icons/icon-kcw.jpg" />

<style>
:root{
  --bg:#f2f4f8;
  --card:#ffffff;
  --line:#20242d;
  --accent:#2f6bff;
  --accent2:#11b5a4;
  --danger:#ff4d4f;
  --text:#11131a;
  --muted:#6b7280;
  --shadow:0 12px 40px rgba(10,20,40,.12);
  --radius:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",system-ui,sans-serif;
  background:radial-gradient(1200px 600px at 20% -10%, #e7f0ff 0%, transparent 60%),
             radial-gradient(900px 500px at 100% 10%, #e7fff6 0%, transparent 55%),
             var(--bg);
  color:var(--text);
}
.wrap{
  max-width:1000px;
  margin:24px auto;
  padding:0 16px 40px;
}
.panel{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:16px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  border:1px solid #e6e9f2;
}
.row{display:flex;gap:8px;margin-bottom:10px;}
label{width:80px;font-size:13px;color:var(--muted);}
input{
  flex:1;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #dde2ee;
  background:#fbfcff;
  color:var(--text);
}
select{
  flex:1;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #dde2ee;
  background:#fbfcff;
  color:var(--text);
}
.titlebar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;}
.icon-btn{
  border:1px solid #e6e9f2;
  background:#f4f7ff;
  color:#2b2f38;
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
}
.icon-btn:hover{background:#eaf0ff;}
.btns{display:grid;grid-template-columns:1.2fr 1.2fr 1.4fr;gap:10px;margin-top:12px;}
button{
  border:0;
  border-radius:10px;
  padding:12px 18px;
  font-weight:600;
  cursor:pointer;
}
.primary{
  background:linear-gradient(135deg,var(--accent),#4b86ff);
  color:#fff;
  box-shadow:0 8px 20px rgba(47,107,255,.25);
}
.danger{background:#ffecec;color:var(--danger);}
.subtle{
  background:linear-gradient(135deg,var(--accent2),#1ac8b6);
  color:#fff;
  box-shadow:0 8px 20px rgba(17,181,164,.22);
}
.warn{
  background:linear-gradient(135deg,#ff4d4f,#ff8a00,#ffd400);
  color:#11131a;
  box-shadow:0 8px 20px rgba(255,138,0,.25);
}
.stealth-grid{
  width:100%;
  height:40px;
  opacity:0;
  border:0;
  background:#000;
  cursor:pointer;
}
.btnSpacer{
  height:40px;
  border-radius:10px;
  background:transparent;
}

#emojiBurst{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:hidden;
}
.burst{
  position:absolute;
  font-size:22px;
  animation:burst-fall 2.2s linear forwards;
  will-change:transform,opacity;
}
@keyframes burst-fall{
  0%{transform:translate3d(0,-10vh,0) rotate(0deg);opacity:0;}
  10%{opacity:1;}
  100%{transform:translate3d(0,110vh,0) rotate(220deg);opacity:0;}
}

canvas{width:100%;height:540px;display:block;}
.slot-wrap{width:240px;height:200px;overflow:hidden;border-radius:14px;border:1px solid #e5e7eb;background:#fafafa;box-shadow:inset 0 0 12px rgba(0,0,0,.06);}
.slot-track{display:flex;flex-direction:column;align-items:center;gap:0;will-change:transform;}
.slot-item{display:flex;align-items:center;justify-content:center;height:200px;}
.slot-item img{max-width:200px;max-height:180px;border-radius:12px;}
.roulette-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center;}
.roulette-col{display:flex;flex-direction:column;align-items:center;gap:8px;}
.roulette-col.secondary{display:none;}
.roulette-col.secondary.show{display:flex;}
.roulette-plus{
  font-weight:800;
  font-size:22px;
  color:#ff7a00;
  display:none;
}
.roulette-plus.show{display:block;}
.toast{
  position:fixed;
  top:16px;
  left:50%;
  transform:translateX(-50%) translateY(-12px);
  display:none;
  align-items:center;
  gap:12px;
  background:#fff;
  padding:12px 14px;
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid #e6e9f2;
  z-index:10;
  animation:toast-in .25s ease-out forwards;
  width:auto;
  max-width:calc(100vw - 24px);
  justify-content:flex-start;
}
.toast.show{display:inline-flex;}
.toast-content{display:flex;align-items:center;gap:12px;flex:0 0 auto;}
.toast-actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
.toast-actions button{min-width:92px;white-space:nowrap;}
.popup-icon{
  font-size:28px;
}
.popup-text{
  font-weight:700;
  white-space:nowrap;
}
@keyframes toast-in{
  from{opacity:0;transform:translateX(-50%) translateY(-12px);}
  to{opacity:1;transform:translateX(-50%) translateY(0);}
}

@media(max-width:900px){
  .panel{grid-template-columns:1fr;}
}
@media(max-width:600px){
  .roulette-row{
    flex-direction:column;
  }
  .toast{
    width:fit-content;
    max-width:calc(100vw - 24px);
    padding:14px 12px;
  }
  .popup-text{
    max-width:72vw;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .toast-actions button{
    min-width:88px;
  }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">

    <!-- ì„¤ì • -->
    <section class="card">
      <div class="titlebar">
        <h3 style="margin:0;">ì‹ ë‚˜ê²Œ ì•„ì´ìŠ¤í¬ë¦¼ ì‚¬ê¸°</h3>
        <button class="icon-btn" id="btnSettings" type="button" aria-label="settings">âš™ï¸ ì„¸íŒ…</button>
      </div>

      <div class="row">
        <label>ì°¸ê°€ì</label>
        <input id="peopleInput" value="íƒœë¯¼, ì°¬ìš°, ì§€ìš©, ìœ¤ì„, ì§€ìš°" />
      </div>
      <div style="margin:-4px 0 8px 88px;font-size:12px;color:var(--muted);">ì‰¼í‘œ(,)ë¡œ ì°¸ê°€ìë¥¼ êµ¬ë¶„í•´ ì£¼ì„¸ìš”.</div>

      <div class="row">
        <label>ê½ ì¸ì›</label>
        <input id="loserCountInput" type="number" min="1" value="1" />
      </div>

      <div class="btns">
        <button class="primary" id="btnGenerate">ì‚¬ë‹¤ë¦¬ ìƒì„±</button>
        <button class="subtle" id="btnRunAll">ì „ì²´ ì‹¤í–‰</button>
        <button class="danger" id="btnReset">ì´ˆê¸°í™”</button>
        <button class="warn split-btn" id="btnSpeed" data-stealth-index="1">ì‚¬ë‹¤ë¦¬ ì†ë„ ì¦ê°€</button>
        <button class="warn split-btn" id="btnSpeedDown" data-stealth-index="2">ì‚¬ë‹¤ë¦¬ ì†ë„ ê°ì†Œ</button>
        <button class="subtle" id="btnFast">ë¹ ë¥¸ ê²°ê³¼ë³´ê¸°</button>
      </div>
    </section>

    <!-- ì‚¬ë‹¤ë¦¬ -->
    <section class="card">
      <canvas id="canvas"></canvas>
      <div id="status" style="margin-top:8px;font-size:13px;color:#666;">ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”</div>
    </section>

  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="modal" style="
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
">
  <div id="emojiBurst" aria-hidden="true"></div>
  <div style="background:#fff;padding:24px;border-radius:16px;min-width:260px;">
    <h3>ğŸ‰ ê²°ê³¼ ğŸ‰</h3>
    <div id="resultList" style="margin:12px 0;"></div>
    <div id="resultFooter" style="margin-top:10px;font-weight:700;color:#11131a;"></div>
    <div style="margin-top:14px;padding-top:10px;border-top:1px dashed #e5e7eb;">
      <div style="font-weight:700;margin-bottom:6px;"> ğŸ¦ ì•„ì´ìŠ¤í¬ë¦¼ ë£°ë › ğŸ¦</div>
      <div class="roulette-row">
        <div class="roulette-col">
          <div class="slot-wrap">
            <div id="slotTrack" class="slot-track"></div>
          </div>
          <div id="rouletteName" style="font-size:16px;font-weight:700;"></div>
        </div>
        <div id="roulettePlus" class="roulette-plus">+</div>
        <div id="rouletteCol2" class="roulette-col secondary">
          <div class="slot-wrap">
            <div id="slotTrack2" class="slot-track"></div>
          </div>
          <div id="rouletteName2" style="font-size:16px;font-weight:700;"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button class="subtle" id="btnSpin">ëŒë¦¬ê¸°</button>
        <button class="warn" id="btnStopSpin">ë©ˆì¶”ê¸°</button>
        <button class="primary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ë£°ë › í™•ì • ì•Œë¦¼ 1 -->
<div id="roulettePopup" class="toast" role="status" aria-live="polite" aria-hidden="true">
  <div class="toast-content">
    <div class="popup-icon">â˜¹ï¸</div>
    <div id="roulettePopupText" class="popup-text"></div>
  </div>
  <div class="toast-actions">
    <button class="danger" id="btnRouletteNo" type="button">ì•„ë‹ˆìš”</button>
    <button class="primary" id="btnRouletteYes" type="button">ë„¤</button>
  </div>
</div>

<!-- ë£°ë › í™•ì • ì•Œë¦¼ 2 -->
<div id="roulettePopup2" class="toast" role="status" aria-live="polite" aria-hidden="true">
  <div class="toast-content">
    <div class="popup-icon">â˜¹ï¸</div>
    <div id="roulettePopupText2" class="popup-text"></div>
  </div>
  <div class="toast-actions">
    <button class="primary" id="btnRouletteYes2" type="button">ë„¤</button>
  </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" style="
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
">
  <div style="background:#fff;padding:14px;border-radius:14px;min-width:260px;max-width:420px;width:88%;">
    <h3 style="margin:0 0 12px;">ì„¸íŒ…</h3>
    <div style="max-height:240px;overflow:auto;padding-right:4px;">
      <div style="font-size:13px;line-height:1.5;color:#394150;margin:0 0 10px;">
        ì°¸ê°€ìì™€ ê½ ì¸ì›ì„ ì„¤ì •í•œ ë’¤ ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”. ì „ì²´ ì‹¤í–‰ì€ ìˆœì„œëŒ€ë¡œ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
    <div style="font-size:12px;color:var(--muted);margin:0 0 6px;">ì†Œë¦¬ ìŒëŸ‰</div>
    <div class="row">
      <label>ë°°ê²½ìŒ</label>
      <input id="bgmVolume" type="range" min="0" max="100" value="60" />
    </div>
    <div class="row">
      <label>ê²°ê³¼ìŒ</label>
      <input id="resultVolume" type="range" min="0" max="100" value="70" />
    </div>
    <div style="display:flex;justify-content:flex-end;margin:4px 0 10px;">
      <button class="danger" id="btnMute" type="button">ìŒì†Œê±°</button>
    </div>
      <div style="font-size:12px;color:var(--muted);margin:0 0 6px;">ì°¸ê°€ì ë§¤í•‘</div>
      <div class="row">
        <label>ì°¸ê°€ì</label>
        <input id="settingsPeopleInput" />
      </div>
      <div class="row">
        <label>ê½ ì¸ì›</label>
        <input id="settingsLoserInput" type="number" min="1" value="1" />
      </div>
      <div style="font-size:12px;color:var(--muted);margin:8px 0 6px;">ì‚¬ë‹¤ë¦¬ ì†ë„</div>
      <div class="row">
        <label>ì†ë„</label>
        <input id="speedRange" type="range" min="200" max="6000" value="3000" />
      </div>
      <div style="height:40px;"></div>
      <div style="font-size:12px;color:var(--muted);margin:10px 0 6px;">ë¹„ë°€ë²„íŠ¼</div>

    <div class="row">
      <label>ë¹„ë°€ë²„íŠ¼ 1</label>
      <input id="secretInput1" placeholder="ì˜ˆ: ì°¬ìš°" />
    </div>
    <div class="row">
      <label>ì•„ì´ìŠ¤í¬ë¦¼</label>
      <select id="secretIcecream1"></select>
    </div>
    <div class="row">
      <label>ë¹„ë°€ë²„íŠ¼ 2</label>
      <input id="secretInput2" placeholder="ì˜ˆ: ì¬í˜" />
    </div>
    <div class="row">
      <label>ì•„ì´ìŠ¤í¬ë¦¼</label>
      <select id="secretIcecream2"></select>
    </div>
    <div class="row">
      <label>ë¹„ë°€ë²„íŠ¼ 3</label>
      <input id="secretInput3" placeholder="ì˜ˆ: ë¯¼ìˆ˜" />
    </div>
    <div class="row">
      <label>ì•„ì´ìŠ¤í¬ë¦¼</label>
      <select id="secretIcecream3"></select>
    </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin:8px 0 0;">
        <button class="subtle" id="btnFairPlay" type="button">ì§„ì§œ ì¡°ì‘ ì—†ì´</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="danger" id="btnSettingsClose" type="button">ë‹«ê¸°</button>
      <button class="primary" id="btnSettingsSave" type="button">ì €ì¥</button>
    </div>
  </div>
</div>

<audio id="bgm" src="sounds/ì‚¬ë‹¤ë¦¬ íƒ€ê¸°.mp3" preload="auto"></audio>
<audio id="resultBgm" src="sounds/ì¥ì„±ì— ëŒ€í•œ ê²½ë¡€ ì†Œì¥.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const peopleInput = document.getElementById("peopleInput");
const loserCountInput = document.getElementById("loserCountInput");
const btnGenerate = document.getElementById("btnGenerate");
const btnRunAll = document.getElementById("btnRunAll");
const btnReset = document.getElementById("btnReset");
const btnFast = document.getElementById("btnFast");
const btnSpeed = document.getElementById("btnSpeed");
const btnSpeedDown = document.getElementById("btnSpeedDown");
const btnSettings = document.getElementById("btnSettings");
const settingsModal = document.getElementById("settingsModal");
const settingsPeopleInput = document.getElementById("settingsPeopleInput");
const settingsLoserInput = document.getElementById("settingsLoserInput");
const secretInput1 = document.getElementById("secretInput1");
const secretInput2 = document.getElementById("secretInput2");
const secretInput3 = document.getElementById("secretInput3");
const secretIcecream1 = document.getElementById("secretIcecream1");
const secretIcecream2 = document.getElementById("secretIcecream2");
const secretIcecream3 = document.getElementById("secretIcecream3");
const btnFairPlay = document.getElementById("btnFairPlay");
const btnSettingsClose = document.getElementById("btnSettingsClose");
const btnSettingsSave = document.getElementById("btnSettingsSave");
const bgmVolume = document.getElementById("bgmVolume");
const resultVolume = document.getElementById("resultVolume");
const speedRange = document.getElementById("speedRange");
const rouletteName = document.getElementById("rouletteName");
const slotTrack = document.getElementById("slotTrack");
const rouletteName2 = document.getElementById("rouletteName2");
const slotTrack2 = document.getElementById("slotTrack2");
const roulettePlus = document.getElementById("roulettePlus");
const rouletteCol2 = document.getElementById("rouletteCol2");
const btnSpin = document.getElementById("btnSpin");
const btnStopSpin = document.getElementById("btnStopSpin");
const roulettePopup = document.getElementById("roulettePopup");
const roulettePopupText = document.getElementById("roulettePopupText");
const btnRouletteYes = document.getElementById("btnRouletteYes");
const btnRouletteNo = document.getElementById("btnRouletteNo");
const roulettePopup2 = document.getElementById("roulettePopup2");
const roulettePopupText2 = document.getElementById("roulettePopupText2");
const btnRouletteYes2 = document.getElementById("btnRouletteYes2");
const modalEl = document.getElementById("modal");
let canvasW=0;
let canvasH=0;
let animToken=0;
let animDuration=3000;
let state={};
let forcedNameNext=null;
let secretTargets=["ì°¬ìš°","ì¬í˜",""];
let secretIcecreamTargets=["","",""];
let fairModeNext=false;
let bgmVol=0.6;
let resultVol=0.7;
let muteOn=false;
let prevBgmVol=bgmVol;
let prevResultVol=resultVol;
let lastLosers=[];
let rouletteSpinId=0;
let rouletteSpinning=false;
let rouletteStopping=false;
let rouletteCurrentIndex=0;
let slotOffset=0;
let roulette2Spinning=false;
let roulette2Stopping=false;
let roulette2CurrentIndex=0;
let slotOffset2=0;
let showPopupOnStop=false;
let forceHaagenNext=false;
let suppressPopupNext=false;
let popupTimer=null;
let lastRouletteItemName="";
let combineNextSpin=false;
let combineBaseName="";

function resize(){
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const fallbackW = canvas.parentElement ? canvas.parentElement.clientWidth : 900;
  const fallbackH = canvas.parentElement ? canvas.parentElement.clientHeight : 540;
  const w = r.width > 10 ? r.width : fallbackW;
  const h = r.height > 10 ? r.height : fallbackH;
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  canvasW = w;
  canvasH = h;
  if(!state.rungs) drawPlaceholder();
}
window.onresize = resize;
resize();
requestAnimationFrame(resize);

function parseCSV(v){return v.split(",").map(s=>s.trim()).filter(Boolean);}
function rng(a,b){return a+Math.random()*(b-a);}

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function generate(opts={}){
  try{
    animToken++;
    stopBgm();
    resize();
    const people=parseCSV(peopleInput.value);
    const N=people.length;
    let loserCount=parseInt(loserCountInput.value,10);
    if(Number.isNaN(loserCount)) loserCount=1;
    loserCount=clamp(loserCount,0,N);
    const useFair=fairModeNext===true;
    fairModeNext=false;
    const forcedName=useFair ? null : (opts.forcedName ?? forcedNameNext);
    forcedNameNext=null;

    if(N<2){
      state={};
      ctx.clearRect(0,0,canvasW,canvasH);
      statusEl.textContent="ì°¸ê°€ìë¥¼ 2ëª… ì´ìƒ ì…ë ¥í•˜ì„¸ìš”";
      drawPlaceholder();
      return;
    }

    const H=Math.floor(rng(22,36));
    const density=rng(0.2,0.3);

    const rungs=Array.from({length:H},()=>Array(N-1).fill(false));
    const yStart=Math.floor(H*0.1);
    const yEnd=Math.ceil(H*0.9);
    for(let y=yStart;y<yEnd;y++){
      for(let x=0;x<N-1;x++){
        if(x>0 && rungs[y][x-1]) continue;
        if(Math.random()<density) rungs[y][x]=true;
      }
    }

    const ends=Array.from({length:N},(_,i)=>traceFrom(i,rungs,H,N));
    const results=assignResults(people,ends,loserCount,forcedName);

    state={people,results,rungs,H,N,ends,resolved:Array(N).fill(null),showNames:false,namesByEnd:[]};
    drawBase();
    statusEl.textContent=useFair ? "ì‚¬ë‹¤ë¦¬ ìƒì„± ì™„ë£Œ (ì§„ì§œ ì¡°ì‘ ì—†ì´)" : "ì‚¬ë‹¤ë¦¬ ìƒì„± ì™„ë£Œ";
    rouletteCurrentIndex=0;
    rouletteSpinning=false;
    rouletteStopping=false;
    rouletteSpinId++;
    if(rouletteName) rouletteName.textContent="ëŒë¦¬ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
    buildSlotTrack();
    if(slotTrack) slotTrack.style.visibility="hidden";
  }catch(e){
    console.error(e);
    statusEl.textContent="ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
  }
}

function openSettings(){
  if(settingsPeopleInput) settingsPeopleInput.value=peopleInput.value;
  if(settingsLoserInput) settingsLoserInput.value=loserCountInput.value;
  if(bgmVolume) bgmVolume.value=Math.round(bgmVol*100);
  if(resultVolume) resultVolume.value=Math.round(resultVol*100);
  if(speedRange) speedRange.value=animDuration;
  if(secretInput1) secretInput1.value=secretTargets[0] || "";
  if(secretInput2) secretInput2.value=secretTargets[1] || "";
  if(secretInput3) secretInput3.value=secretTargets[2] || "";
  buildIcecreamSelect(secretIcecream1);
  buildIcecreamSelect(secretIcecream2);
  buildIcecreamSelect(secretIcecream3);
  if(secretIcecream1) secretIcecream1.value=secretIcecreamTargets[0] || "";
  if(secretIcecream2) secretIcecream2.value=secretIcecreamTargets[1] || "";
  if(secretIcecream3) secretIcecream3.value=secretIcecreamTargets[2] || "";
  if(settingsModal) settingsModal.style.display="flex";
}

function closeSettings(){
  if(settingsModal) settingsModal.style.display="none";
}

function saveSettings(){
  if(settingsPeopleInput) peopleInput.value=settingsPeopleInput.value;
  if(settingsLoserInput) loserCountInput.value=settingsLoserInput.value;
  secretTargets=[
    (secretInput1 && secretInput1.value ? secretInput1.value.trim() : ""),
    (secretInput2 && secretInput2.value ? secretInput2.value.trim() : ""),
    (secretInput3 && secretInput3.value ? secretInput3.value.trim() : "")
  ];
  secretIcecreamTargets=[
    (secretIcecream1 && secretIcecream1.value ? secretIcecream1.value : ""),
    (secretIcecream2 && secretIcecream2.value ? secretIcecream2.value : ""),
    (secretIcecream3 && secretIcecream3.value ? secretIcecream3.value : "")
  ];
  if(bgmVolume) bgmVol=clamp(parseInt(bgmVolume.value,10)/100,0,1);
  if(resultVolume) resultVol=clamp(parseInt(resultVolume.value,10)/100,0,1);
  muteOn=(bgmVol===0 && resultVol===0);
  if(speedRange) animDuration=clamp(parseInt(speedRange.value,10),200,6000);
  statusEl.textContent="ì„¸íŒ… ì €ì¥ ì™„ë£Œ. ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
  closeSettings();
}

function traceFrom(start,rungs,H,N){
  let c=start;
  for(let y=0;y<H;y++){
    if(c<N-1 && rungs[y][c]) c++;
    else if(c>0 && rungs[y][c-1]) c--;
  }
  return c;
}

function assignResults(people,ends,loserCount,forcedName){
  const N=people.length;
  const results=Array(N).fill("ìƒì¡´");
  const idxForced=forcedName ? people.indexOf(forcedName) : -1;

  let losers=[];
  const indices=Array.from({length:N},(_,i)=>i);
  if(idxForced>=0 && loserCount>0){
    if(loserCount===1){
      losers=[idxForced];
    }else{
      const pool=indices.filter(i=>i!==idxForced);
      shuffle(pool);
      losers=pool.slice(0,Math.max(0,loserCount-1));
      losers.push(idxForced);
    }
  }else{
    shuffle(indices);
    losers=indices.slice(0,loserCount);
  }

  losers.forEach(i=>{results[ends[i]]="ê½";});
  return results;
}

function drawBase(){
  ctx.clearRect(0,0,canvasW,canvasH);
  if(!state.rungs) return;

  const lineColor="#20242d";
  const side=40, top=48, bot=56;
  const colGap=(canvasW-2*side)/(state.N-1);
  const rowGap=(canvasH-top-bot)/(state.H-1);
  ctx.strokeStyle=lineColor;
  ctx.lineWidth=1;
  ctx.fillStyle="#11131a";
  ctx.font="700 16px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";

  const showNames=state.showNames===true;
  const resultY=showNames ? canvasH-30 : canvasH-16;
  const namesY=canvasH-12;

  state.people.forEach((p,i)=>{
    ctx.textAlign="center";
    ctx.fillText(p, side+i*colGap, 20);
    const isLoser=state.results[i]==="ê½";
    ctx.fillStyle=isLoser ? "#ff4d4f" : "#12a58f";
    ctx.font="800 16px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";
    ctx.fillText(state.results[i], side+i*colGap, resultY);
    ctx.fillStyle="#11131a";
    ctx.font="700 16px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";
  });
  if(showNames && Array.isArray(state.namesByEnd)){
    ctx.font="600 12px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";
    ctx.fillStyle="#6b7280";
    state.namesByEnd.forEach((names,i)=>{
      if(!names || names.length===0) return;
      const text=names.join(" ");
      ctx.fillText(text, side+i*colGap, namesY);
    });
    ctx.fillStyle="#11131a";
    ctx.font="700 16px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";
  }

  for(let i=0;i<state.N;i++){
    ctx.beginPath();
    ctx.moveTo(side+i*colGap,top);
    ctx.lineTo(side+i*colGap,canvasH-bot);
    ctx.stroke();
  }

  for(let y=0;y<state.H;y++){
    for(let x=0;x<state.N-1;x++){
      if(state.rungs[y][x]){
        ctx.beginPath();
        ctx.moveTo(side+x*colGap,top+y*rowGap);
        ctx.lineTo(side+(x+1)*colGap,top+y*rowGap);
        ctx.stroke();
      }
    }
  }
}

function drawPlaceholder(){
  ctx.clearRect(0,0,canvasW,canvasH);
  ctx.fillStyle="#1f2533";
  ctx.font="800 24px \"Pretendard\",\"Noto Sans KR\",system-ui,sans-serif";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText("ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”", canvasW/2, canvasH/2);
  ctx.textBaseline="alphabetic";
}

function buildPath(start){
  const side=40, top=48, bot=56;
  const colGap=(canvasW-2*side)/(state.N-1);
  const rowGap=(canvasH-top-bot)/(state.H-1);
  let c=start;
  const pts=[];
  let x=side+c*colGap;
  pts.push({x,y:top});
  for(let y=0;y<state.H;y++){
    const yPos=top+y*rowGap;
    if(y>0) pts.push({x,y:yPos});
    if(c<state.N-1 && state.rungs[y][c]){
      c++;
      x=side+c*colGap;
      pts.push({x,y:yPos});
    }else if(c>0 && state.rungs[y][c-1]){
      c--;
      x=side+c*colGap;
      pts.push({x,y:yPos});
    }
  }
  pts.push({x,y:canvasH-bot});  
  return pts;
}

function drawPartialPath(pts, maxLen, color){
  ctx.strokeStyle=color;
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  let remaining=maxLen;
  for(let i=1;i<pts.length;i++){
    const a=pts[i-1], b=pts[i];
    const seg=Math.hypot(b.x-a.x,b.y-a.y);
    if(remaining>=seg){
      ctx.lineTo(b.x,b.y);
      remaining-=seg;
    }else{
      const t=remaining/seg;
      const x=a.x+(b.x-a.x)*t;
      const y=a.y+(b.y-a.y)*t;
      ctx.lineTo(x,y);
      break;
    }
  }
  ctx.stroke();
  ctx.lineWidth=1;
  ctx.strokeStyle="#2b2f38";
}

async function animatePath(start, color){
  const myToken=animToken;
  const pts=buildPath(start);
  let total=0;
  for(let i=1;i<pts.length;i++){
    total+=Math.hypot(pts[i].x-pts[i-1].x,pts[i].y-pts[i-1].y);
  }
  const duration=animDuration;
  const t0=performance.now();
  return new Promise(resolve=>{
    function frame(t){
      if(myToken!==animToken){resolve(false);return;}
      const p=Math.min(1,(t-t0)/duration);
      drawBase();
      drawPartialPath(pts,total*p,color);
      if(p<1) requestAnimationFrame(frame);
      else resolve(true);
    }
    requestAnimationFrame(frame);
  });
}

async function runAll(){
  const myToken=++animToken;
  if(!state.rungs || !state.N){
    statusEl.textContent="ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”";
    stopBgm();
    alert("ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  statusEl.textContent="ì‹¤í–‰ ì¤‘...";
  startBgm();
  state.namesByEnd=Array.from({length:state.N},()=>[]);
  state.showNames=false;
  for(let i=0;i<state.N;i++){
    const ok=await animatePath(i,"#1a73e8");
    if(!ok || myToken!==animToken) return;
    state.resolved[i]=state.ends[i];
    const end=state.ends[i];
    state.namesByEnd[end].push(state.people[i]);
    state.showNames=true;
    drawBase();
  }
  showModal();
}

function fastResult(){
  if(!state.rungs || !state.N){
    statusEl.textContent="ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”";
    stopBgm();
    alert("ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  animToken++;
  state.namesByEnd=Array.from({length:state.N},()=>[]);
  state.people.forEach((name,i)=>{
    const end=state.ends[i];
    state.resolved[i]=end;
    state.namesByEnd[end].push(name);
  });
  state.showNames=true;
  drawBase();
  showModal();
}

function showModal(){
  hideRoulettePopup();
  const list=document.getElementById("resultList");
  list.innerHTML="";
  const losers=[];
  state.people.forEach((p,i)=>{
    const d=document.createElement("div");
    d.textContent=`${p} â†’ ${state.results[state.resolved[i]]}`;
    list.appendChild(d);
    if(state.results[state.resolved[i]]==="ê½") losers.push(p);
  });
  const footer=document.getElementById("resultFooter");
  const sentence=`ì”ë‚˜ê²Œ ì•„ì´ìŠ¤í¬ë¦¼ ì‚´ ì‚¬ëŒì€ ${losers.join(", ")}!!!`;
  footer.textContent=sentence;
  lastLosers=losers.slice();
  rouletteSpinning=false;
  rouletteStopping=false;
  rouletteSpinId++;
  rouletteCurrentIndex=Math.floor(Math.random()*icecreamItems.length);
  roulette2CurrentIndex=Math.floor(Math.random()*icecreamItems.length);
  buildSlotTrack();
  buildSlotTrack2();
  slotOffset=0;
  slotOffset2=0;
  if(slotTrack) slotTrack.style.transform=`translateY(${slotOffset}px)`;
  if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
  if(slotTrack) slotTrack.style.visibility="hidden";
  if(slotTrack2) slotTrack2.style.visibility="hidden";
  if(rouletteName) rouletteName.textContent="ëŒë¦¬ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”";
  if(rouletteName2) rouletteName2.textContent="";
  if(roulettePlus) roulettePlus.classList.remove("show");
  if(rouletteCol2) rouletteCol2.classList.remove("show");
  startEmojiBurst();
  speakResult(sentence);
  stopBgm();
  playResultBgm();
  document.getElementById("modal").style.display="flex";
}

function closeModal(){
  document.getElementById("modal").style.display="none";
  stopEmojiBurst();
  stopSpeak();
  stopResultBgm();
  hideRoulettePopup();
  hideRoulettePopup2();
}

let burstTimer=null;
function startEmojiBurst(){
  const box=document.getElementById("emojiBurst");
  if(!box) return;
  box.innerHTML="";
  const emojis=["ğŸ¦","ğŸ‰","ğŸ†","âœ¨","ğŸ‡","ğŸ§"];
  const spawn=()=>{
    for(let i=0;i<12;i++){
      const el=document.createElement("div");
      el.className="burst";
      el.textContent=emojis[Math.floor(Math.random()*emojis.length)];
      el.style.left=Math.random()*100+"%";
      el.style.animationDuration=(1.6+Math.random()*1.6)+"s";
      el.style.fontSize=(18+Math.random()*18)+"px";
      el.style.opacity="0";
      box.appendChild(el);
      el.addEventListener("animationend",()=>el.remove());
    }
  };
  spawn();
  burstTimer=setInterval(spawn,700);
}

function stopEmojiBurst(){
  if(burstTimer) clearInterval(burstTimer);
  burstTimer=null;
  const box=document.getElementById("emojiBurst");
  if(box) box.innerHTML="";
}

function speakResult(text){
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const uttr=new SpeechSynthesisUtterance(text);
  uttr.lang="ko-KR";
  uttr.rate=1.0;
  uttr.pitch=1.0;
  window.speechSynthesis.speak(uttr);
}

function stopSpeak(){
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
}

function startBgm(){
  const audio=document.getElementById("bgm");
  if(!audio) return;
  audio.currentTime=0;
  audio.volume=bgmVol;
  const p=audio.play();
  if(p && typeof p.catch==="function") p.catch(()=>{});
}

function stopBgm(){
  const audio=document.getElementById("bgm");
  if(!audio) return;
  audio.pause();
  audio.currentTime=0;
}

function playResultBgm(){
  const audio=document.getElementById("resultBgm");
  if(!audio) return;
  audio.currentTime=0;
  audio.volume=resultVol;
  const p=audio.play();
  if(p && typeof p.catch==="function") p.catch(()=>{});
}

function stopResultBgm(){
  const audio=document.getElementById("resultBgm");
  if(!audio) return;
  audio.pause();
  audio.currentTime=0;
}

const icecreamItems=[
  {name:"ë”ë¸”ë¹„ì•ˆì½”",src:"icecream/ë”ë¸”ë¹„ì•ˆì½”.jpeg"},
  {name:"ë¼ì§€ë°”",src:"icecream/ë¼ì§€ë°”.jpeg"},
  {name:"ë¶€ë¼ë³´",src:"icecream/ë¶€ë¼ë³´.jpeg"},
  {name:"ì˜¤ë ˆì˜¤",src:"icecream/ì˜¤ë ˆì˜¤.jpeg"},
  {name:"ì¸ì ˆë¯¸ì½˜",src:"icecream/ì¸ì ˆë¯¸ì½˜.jpeg"},
  {name:"ì£¼í† í”¼ì•„",src:"icecream/ì£¼í† í”¼ì•„.png"},
  {name:"ì°°ë–¡ì•„ì´ìŠ¤",src:"icecream/ì°°ë–¡ì•„ì´ìŠ¤.jpeg"},
  {name:"íŒŒë¥´í˜",src:"icecream/íŒŒë¥´í˜.png"},
  {name:"í•˜ê²ë‹¤ì¦ˆ",src:"icecream/í•˜ê²ë‹¤ì¦ˆ.jpeg"}
];
const rouletteColors=["#ff3b30","#ff9500","#34c759","#007aff","#5856d6","#ff2d55"];

function buildIcecreamSelect(selectEl){
  if(!selectEl) return;
  if(selectEl.options && selectEl.options.length>0) return;
  const optEmpty=document.createElement("option");
  optEmpty.value="";
  optEmpty.textContent="(ëœë¤)";
  selectEl.appendChild(optEmpty);
  icecreamItems.forEach((item)=>{
    const opt=document.createElement("option");
    opt.value=item.name;
    opt.textContent=item.name;
    selectEl.appendChild(opt);
  });
}

function getForcedIcecreamIndex(){
  for(let i=0;i<secretTargets.length;i++){
    const name=secretTargets[i];
    const ice=secretIcecreamTargets[i];
    if(!name || !ice) continue;
    if(lastLosers.includes(name)){
      const idx=icecreamItems.findIndex(it=>it.name===ice);
      if(idx>=0) return idx;
    }
  }
  return -1;
}

function showRoulettePopup(){
  if(!roulettePopup || !roulettePopupText) return;
  const name=(lastLosers && lastLosers.length>0) ? lastLosers[0] : "ëˆ„êµ°ê°€";
  roulettePopupText.textContent=`${name}(ì´)ê°€ ì”ë‚˜ë³´ì´ë‚˜ìš”?`;
  roulettePopup.classList.add("show");
  roulettePopup.setAttribute("aria-hidden","false");
}

function showRoulettePopup2(){
  if(!roulettePopup2 || !roulettePopupText2) return;
  if(modalEl && modalEl.style.display!=="flex") return;
  const name=(lastLosers && lastLosers.length>0) ? lastLosers[0] : "ëˆ„êµ°ê°€";
  roulettePopupText2.textContent=`${name} (ì´)ê°€ ì´ì œëŠ” ì”ë‚˜ë³´ì´ì£ ?`;
  roulettePopup2.classList.add("show");
  roulettePopup2.setAttribute("aria-hidden","false");
}

function hideRoulettePopup(){
  if(popupTimer){
    clearTimeout(popupTimer);
    popupTimer=null;
  }
  if(!roulettePopup) return;
  roulettePopup.classList.remove("show");
  roulettePopup.setAttribute("aria-hidden","true");
}

function hideRoulettePopup2(){
  if(!roulettePopup2) return;
  roulettePopup2.classList.remove("show");
  roulettePopup2.setAttribute("aria-hidden","true");
}

function spinToHaagen(){
  forceHaagenNext=true;
  suppressPopupNext=true;
  renderRouletteItem(rouletteCurrentIndex);
  startSpin();
  setTimeout(()=>stopSpin(), 1100);
}

function spinToCombine(){
  combineNextSpin=true;
  combineBaseName=lastRouletteItemName || "";
  suppressPopupNext=true;
  buildSlotTrack2();
  if(rouletteName2) rouletteName2.textContent="";
  roulette2Spinning=false;
  roulette2Stopping=false;
  roulette2CurrentIndex=Math.floor(Math.random()*icecreamItems.length);
  slotOffset2=0;
  if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
  if(slotTrack2) slotTrack2.style.visibility="visible";
  if(rouletteCol2) rouletteCol2.classList.add("show");
  if(roulettePlus) roulettePlus.classList.add("show");
  startSpin2();
  setTimeout(()=>stopSpin2(), 1100);
}

function renderRouletteItem(idx){
  const item=icecreamItems[idx % icecreamItems.length];
  if(rouletteName) rouletteName.textContent=item.name;
  if(rouletteName){
    rouletteName.style.color=rouletteColors[idx % rouletteColors.length];
  }
}

function buildSlotTrack(){
  if(!slotTrack) return;
  slotTrack.innerHTML="";
  const repeat=6;
  for(let r=0;r<repeat;r++){
    icecreamItems.forEach((item)=>{
      const box=document.createElement("div");
      box.className="slot-item";
      const img=document.createElement("img");
      img.src=item.src;
      img.alt=item.name;
      box.appendChild(img);
      slotTrack.appendChild(box);
    });
  }
  slotOffset=0;
  slotTrack.style.transform="translateY(0px)";
}

function buildSlotTrack2(){
  if(!slotTrack2) return;
  slotTrack2.innerHTML="";
  const repeat=6;
  for(let r=0;r<repeat;r++){
    icecreamItems.forEach((item)=>{
      const box=document.createElement("div");
      box.className="slot-item";
      const img=document.createElement("img");
      img.src=item.src;
      img.alt=item.name;
      box.appendChild(img);
      slotTrack2.appendChild(box);
    });
  }
  slotOffset2=0;
  slotTrack2.style.transform="translateY(0px)";
}

function startSpin(){
  if(rouletteSpinning || rouletteStopping) return;
  rouletteSpinning=true;
  if(slotTrack) slotTrack.style.visibility="visible";
  const myId=++rouletteSpinId;
  let last=performance.now();
  let speed=18; // items per second
  let acc=0;
  const itemH=200;
  const trackH=itemH*icecreamItems.length*6;
  function frame(t){
    if(myId!==rouletteSpinId) return;
    const dt=(t-last)/1000;
    last=t;
    acc+=dt*speed;
    const step=Math.floor(acc);
    if(step>0){
      acc-=step;
      rouletteCurrentIndex=(rouletteCurrentIndex+step)%icecreamItems.length;
      slotOffset-=step*itemH;
      if(slotOffset<=-trackH+itemH*icecreamItems.length){
        slotOffset+=itemH*icecreamItems.length;
      }
      if(slotTrack) slotTrack.style.transform=`translateY(${slotOffset}px)`;
      renderRouletteItem(rouletteCurrentIndex);
    }
    if(rouletteSpinning) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function startSpin2(){
  if(roulette2Spinning || roulette2Stopping) return;
  roulette2Spinning=true;
  if(slotTrack2) slotTrack2.style.visibility="visible";
  if(roulettePlus) roulettePlus.classList.add("show");
  const myId=++rouletteSpinId;
  let last=performance.now();
  let speed=18; // items per second
  let acc=0;
  const itemH=200;
  const trackH=itemH*icecreamItems.length*6;
  function frame(t){
    if(myId!==rouletteSpinId) return;
    const dt=(t-last)/1000;
    last=t;
    acc+=dt*speed;
    const step=Math.floor(acc);
    if(step>0){
      acc-=step;
      roulette2CurrentIndex=(roulette2CurrentIndex+step)%icecreamItems.length;
      slotOffset2-=step*itemH;
      if(slotOffset2<=-trackH+itemH*icecreamItems.length){
        slotOffset2+=itemH*icecreamItems.length;
      }
      if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
      if(rouletteName2) rouletteName2.textContent=icecreamItems[roulette2CurrentIndex].name;
    }
    if(roulette2Spinning) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function stopSpin(){
  if(!rouletteSpinning || rouletteStopping) return;
  rouletteStopping=true;
  rouletteSpinning=false;
  showPopupOnStop=true;
  const myId=++rouletteSpinId;
  let forcedIdx=-1;
  if(forceHaagenNext){
    forcedIdx=icecreamItems.findIndex((it)=>it.name==="í•˜ê²ë‹¤ì¦ˆ");
    forceHaagenNext=false;
  }else{
    forcedIdx=getForcedIcecreamIndex();
  }
  let last=performance.now();
  let speed=16;
  let acc=0;
  const itemH=200;
  const trackH=itemH*icecreamItems.length*6;
  function frame(t){
    if(myId!==rouletteSpinId) return;
    const dt=(t-last)/1000;
    last=t;
    speed=Math.max(0, speed-6*dt);
    acc+=dt*speed;
    const step=Math.floor(acc);
    if(step>0){
      acc-=step;
      rouletteCurrentIndex=(rouletteCurrentIndex+step)%icecreamItems.length;
      slotOffset-=step*itemH;
      if(slotOffset<=-trackH+itemH*icecreamItems.length){
        slotOffset+=itemH*icecreamItems.length;
      }
      if(slotTrack) slotTrack.style.transform=`translateY(${slotOffset}px)`;
      renderRouletteItem(rouletteCurrentIndex);
    }
    if(speed>0.1){
      requestAnimationFrame(frame);
    }else{
      rouletteStopping=false;
      if(forcedIdx>=0){
        rouletteCurrentIndex=forcedIdx;
      }
      settleToCurrent();
    }
  }
  requestAnimationFrame(frame);
}

function stopSpin2(){
  if(!roulette2Spinning || roulette2Stopping) return;
  roulette2Stopping=true;
  roulette2Spinning=false;
  const myId=++rouletteSpinId;
  let last=performance.now();
  let speed=16;
  let acc=0;
  const itemH=200;
  const trackH=itemH*icecreamItems.length*6;
  function frame(t){
    if(myId!==rouletteSpinId) return;
    const dt=(t-last)/1000;
    last=t;
    speed=Math.max(0, speed-6*dt);
    acc+=dt*speed;
    const step=Math.floor(acc);
    if(step>0){
      acc-=step;
      roulette2CurrentIndex=(roulette2CurrentIndex+step)%icecreamItems.length;
      slotOffset2-=step*itemH;
      if(slotOffset2<=-trackH+itemH*icecreamItems.length){
        slotOffset2+=itemH*icecreamItems.length;
      }
      if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
      if(rouletteName2) rouletteName2.textContent=icecreamItems[roulette2CurrentIndex].name;
    }
    if(speed>0.1){
      requestAnimationFrame(frame);
    }else{
      roulette2Stopping=false;
      settleToCurrent2();
    }
  }
  requestAnimationFrame(frame);
}

function settleToCurrent(){
  const itemH=200;
  const target=-rouletteCurrentIndex*itemH;
  const start=slotOffset;
  const duration=260;
  const t0=performance.now();
  function frame(t){
    const p=Math.min(1,(t-t0)/duration);
    const eased=1-Math.pow(1-p,3);
    slotOffset=start+(target-start)*eased;
    if(slotTrack) slotTrack.style.transform=`translateY(${slotOffset}px)`;
    if(p<1) requestAnimationFrame(frame);
    else{
      slotOffset=target;
      if(slotTrack) slotTrack.style.transform=`translateY(${slotOffset}px)`;
      renderRouletteItem(rouletteCurrentIndex);
      lastRouletteItemName=icecreamItems[rouletteCurrentIndex].name;
      if(showPopupOnStop){
        showPopupOnStop=false;
        if(popupTimer){
          clearTimeout(popupTimer);
          popupTimer=null;
        }
        showRoulettePopup();
      }
    }
  }
  requestAnimationFrame(frame);
}

function settleToCurrent2(){
  const itemH=200;
  const target=-roulette2CurrentIndex*itemH;
  const start=slotOffset2;
  const duration=260;
  const t0=performance.now();
  function frame(t){
    const p=Math.min(1,(t-t0)/duration);
    const eased=1-Math.pow(1-p,3);
    slotOffset2=start+(target-start)*eased;
    if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
    if(p<1) requestAnimationFrame(frame);
    else{
      slotOffset2=target;
      if(slotTrack2) slotTrack2.style.transform=`translateY(${slotOffset2}px)`;
      if(rouletteName2) rouletteName2.textContent=icecreamItems[roulette2CurrentIndex].name;
      showRoulettePopup2();
    }
  }
  requestAnimationFrame(frame);
}

if(btnGenerate) btnGenerate.onclick=generate;
if(btnRunAll) btnRunAll.onclick=runAll;
if(btnFast) btnFast.onclick=fastResult;
if(btnSpeed) btnSpeed.onclick=()=>{
  animDuration=Math.max(200,Math.floor(animDuration*0.85));
  statusEl.textContent=`ì‚¬ë‹¤ë¦¬ ì†ë„ ì¦ê°€ (${animDuration}ms)`;
};
if(btnSpeedDown) btnSpeedDown.onclick=()=>{
  animDuration=Math.min(6000,Math.floor(animDuration*1.2));
  statusEl.textContent=`ì‚¬ë‹¤ë¦¬ ì†ë„ ê°ì†Œ (${animDuration}ms)`;
};
if(btnReset) btnReset.onclick=(e)=>{
  if(e){
    const rect=btnReset.getBoundingClientRect();
    const x=e.clientX-rect.left;
    if(x<=rect.width/2){
      forcedNameNext=secretTargets[0] || null;
      return;
    }
  }
  animToken++;
  stopBgm();
  stopResultBgm();
  state={};
  ctx.clearRect(0,0,canvasW,canvasH);
  statusEl.textContent="ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ëˆ„ë¥´ì„¸ìš”";
  drawPlaceholder();
};
document.querySelectorAll(".split-btn").forEach((btn)=>{
  btn.addEventListener("click",(e)=>{
    const rect=btn.getBoundingClientRect();
    const y=e.clientY-rect.top;
    const half=rect.height/2;
    if(y<=half) return;
    e.preventDefault();
    e.stopImmediatePropagation();
    const idx=parseInt(btn.dataset.stealthIndex,10);
    if(Number.isNaN(idx)) return;
    forcedNameNext=secretTargets[idx] || null;
  }, true);
});
if(btnSettings) btnSettings.onclick=openSettings;
if(btnSettingsClose) btnSettingsClose.onclick=closeSettings;
if(btnSettingsSave) btnSettingsSave.onclick=saveSettings;
const btnMute = document.getElementById("btnMute");
if(btnMute) btnMute.onclick=()=>{
  if(!muteOn){
    prevBgmVol=bgmVol;
    prevResultVol=resultVol;
    bgmVol=0;
    resultVol=0;
    if(bgmVolume) bgmVolume.value=0;
    if(resultVolume) resultVolume.value=0;
    muteOn=true;
  }else{
    bgmVol=prevBgmVol || 0.6;
    resultVol=prevResultVol || 0.7;
    if(bgmVolume) bgmVolume.value=Math.round(bgmVol*100);
    if(resultVolume) resultVolume.value=Math.round(resultVol*100);
    muteOn=false;
  }
};
if(btnFairPlay) btnFairPlay.onclick=()=>{
  fairModeNext=true;
  forcedNameNext=null;
  statusEl.textContent="ë‹¤ìŒ í•œ íŒë§Œ ì§„ì§œ ì¡°ì‘ ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤. ì‚¬ë‹¤ë¦¬ ìƒì„±ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
  closeSettings();
};
if(btnSpin) btnSpin.onclick=()=>{
  renderRouletteItem(rouletteCurrentIndex);
  startSpin();
};
if(btnStopSpin) btnStopSpin.onclick=stopSpin;
if(btnRouletteYes) btnRouletteYes.onclick=hideRoulettePopup;
if(btnRouletteYes2) btnRouletteYes2.onclick=hideRoulettePopup2;
if(btnRouletteNo) btnRouletteNo.onclick=()=>{
  hideRoulettePopup();
  spinToCombine();
};
if(settingsModal) settingsModal.addEventListener("click",(e)=>{
  if(e.target===settingsModal) closeSettings();
});

drawPlaceholder();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  });
}
</script>
</body>
</html>
